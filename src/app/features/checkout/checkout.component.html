<div class="checkout-container">
  <div class="checkout-header">
    <h1>Finalizar Compra</h1>
    <p>Completa tus datos para continuar con el pago</p>
    <p class="checkout-trust">Pago seguro con Wompi · Envíos nacionales</p>
  </div>

  <div class="checkout-alert" *ngIf="statusMessage">
    {{ statusMessage }}
  </div>

  <div class="checkout-content">
    <!-- Formulario -->
    <div class="checkout-form-section">
      <div class="checkout-login-hint" *ngIf="!(isLoggedIn$ | async)">
        <div class="checkout-login-icon">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="checkout-login-copy">
          <p class="title">¿Tienes cuenta en Kalad?</p>
          <p class="subtitle">
            Inicia sesión con Google para guardar tus datos, ver tu historial de pedidos y usar tus favoritos.
            Si lo prefieres, puedes continuar tu compra sin iniciar sesión.
          </p>
        </div>
        <button type="button" class="btn-google" (click)="loginWithGoogle()" [disabled]="isProcessing">
          <i class="fab fa-google"></i>
          <span>Iniciar sesión con Google</span>
        </button>
      </div>
      <form [formGroup]="checkoutForm" (ngSubmit)="processPayment()">

        <!-- Datos Personales -->
        <section class="form-section">
          <h2><i class="fas fa-user"></i> Datos Personales</h2>

          <div class="form-group">
            <label for="fullName">Nombre Completo *</label>
            <input
              type="text"
              id="fullName"
              formControlName="fullName"
              placeholder="Ej: Juan Perez"
              [class.error]="f['fullName'].invalid && f['fullName'].touched">
            <span class="error-message" *ngIf="f['fullName'].invalid && f['fullName'].touched">
              <ng-container *ngIf="f['fullName'].errors?.['required']">
                El nombre es requerido
              </ng-container>
              <ng-container *ngIf="f['fullName'].errors?.['minlength']">
                El nombre debe tener al menos 3 caracteres
              </ng-container>
            </span>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="email">Correo Electronico *</label>
              <input
                type="email"
                id="email"
                formControlName="email"
                placeholder="ejemplo@correo.com"
                [class.error]="f['email'].invalid && f['email'].touched">
              <span class="error-message" *ngIf="f['email'].invalid && f['email'].touched">
                <ng-container *ngIf="f['email'].errors?.['required']">
                  El correo es requerido
                </ng-container>
                <ng-container *ngIf="f['email'].errors?.['email']">
                  Ingresa un correo valido
                </ng-container>
              </span>
            </div>

            <div class="form-group">
              <label for="phone">Telefono *</label>
              <input
                type="tel"
                id="phone"
                formControlName="phone"
                placeholder="3001234567"
                maxlength="10"
                [class.error]="f['phone'].invalid && f['phone'].touched">
              <span class="error-message" *ngIf="f['phone'].invalid && f['phone'].touched">
                Ingresa un telefono valido de 10 digitos
              </span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="documentType">Tipo de Documento *</label>
              <select id="documentType" formControlName="documentType">
                <option value="CC">Cedula de Ciudadania</option>
                <option value="CE">Cedula de Extranjeria</option>
                <option value="NIT">NIT</option>
                <option value="PP">Pasaporte</option>
              </select>
            </div>

            <div class="form-group">
              <label for="documentNumber">Numero de Documento *</label>
              <input
                type="text"
                id="documentNumber"
                formControlName="documentNumber"
                placeholder="1234567890"
                [class.error]="f['documentNumber'].invalid && f['documentNumber'].touched">
              <span class="error-message" *ngIf="f['documentNumber'].invalid && f['documentNumber'].touched">
                Ingresa solo numeros
              </span>
            </div>
          </div>
        </section>

        <!-- Direccion de Envio -->
        <section class="form-section">
          <h2><i class="fas fa-map-marker-alt"></i> Direccion de Envio</h2>

          <div class="form-group">
            <label for="address">Direccion *</label>
            <input
              type="text"
              id="address"
              formControlName="address"
              placeholder="Ej: Calle 123 #45-67, Apto 801"
              [class.error]="f['address'].invalid && f['address'].touched">
            <span class="error-message" *ngIf="f['address'].invalid && f['address'].touched">
              La direccion es requerida
            </span>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="city">Ciudad *</label>
              <input
                type="text"
                id="city"
                formControlName="city"
                placeholder="Ej: Bogota"
                [class.error]="f['city'].invalid && f['city'].touched">
              <span class="error-message" *ngIf="f['city'].invalid && f['city'].touched">
                La ciudad es requerida
              </span>
            </div>

            <div class="form-group">
              <label for="department">Departamento *</label>
              <input
                type="text"
                id="department"
                formControlName="department"
                placeholder="Ej: Cundinamarca"
                [class.error]="f['department'].invalid && f['department'].touched">
              <span class="error-message" *ngIf="f['department'].invalid && f['department'].touched">
                El departamento es requerido
              </span>
            </div>
          </div>

        </section>

        <!-- Notas Adicionales -->
        <section class="form-section">
          <h2><i class="fas fa-sticky-note"></i> Notas Adicionales (Opcional)</h2>

          <div class="form-group">
            <textarea
              id="notes"
              formControlName="notes"
              placeholder="Alguna instruccion especial para la entrega?"
              rows="4"></textarea>
          </div>
        </section>

        <!-- Botones -->
        <div class="form-actions">
          <button
            type="button"
            class="btn-secondary"
            (click)="continueShopping()">
            <i class="fas fa-arrow-left"></i> Seguir Comprando
          </button>

          <button
            type="submit"
            class="btn-primary"
            style="background:#cb5e30;color:#ffffff;border-color:#cb5e30;"
            [disabled]="isProcessing">
            <ng-container *ngIf="isProcessing; else payLabel">
              <i class="fas fa-spinner fa-spin"></i> Procesando...
            </ng-container>
            <ng-template #payLabel>
              <i class="fas fa-credit-card"></i> Pagar ahora {{ formatPrice(getTotal()) }}
            </ng-template>
          </button>
        </div>
      </form>
    </div>

    <!-- Resumen del Pedido -->
    <div class="order-summary">
      <h2>Resumen del Pedido</h2>

      <div class="cart-items">
        <div
          class="cart-item"
          *ngFor="let item of cartItems; trackBy: trackCartItem"
        >
          <img [src]="item.imagen" [alt]="item.nombre" loading="lazy" />
          <div class="item-details">
            <h3>{{ item.nombre }}</h3>
            <p>Color: {{ item.color }}</p>
            <p>Cantidad: {{ item.qty }}</p>
          </div>
          <div class="item-price">
            {{ formatPrice(item.precio * item.qty) }}
          </div>
        </div>
      </div>

      <div class="cupon">
        <input
          type="text"
          placeholder="Cupon (ej: KALAD10)"
          [(ngModel)]="couponCode"
        />
        <button type="button" (click)="applyCoupon()">Aplicar</button>
        <button type="button" class="link" *ngIf="discount" (click)="resetCoupon()">Quitar</button>
      </div>

      <p class="cupon-msg" *ngIf="couponMessage">{{ couponMessage }}</p>

      <div class="summary-details">
        <div class="summary-row">
          <span>Subtotal</span>
          <span>{{ formatPrice(getSubtotal()) }}</span>
        </div>
        <div class="summary-row">
          <span>Descuento</span>
          <span>- {{ formatPrice(discount) }}</span>
        </div>
        <div class="summary-row">
          <span>Envio</span>
          <span>{{ formatPrice(shipping) }}</span>
        </div>
        <div class="summary-row total">
          <span>Total a pagar</span>
          <span>{{ formatPrice(getTotal()) }}</span>
        </div>
      </div>

      <div
        class="shipping-psych"
        *ngIf="shippingMessageDetail"
        style="border:1px solid #f1c7a0; border-radius:12px; background:#fff3e5; padding:14px 16px; color:#a0470a; margin-top:16px;"
      >
        <div
          style="display:flex; align-items:center; gap:10px; margin-bottom:4px;"
          aria-live="polite"
        >
          <span style="font-size:20px;">🚚</span>
          <p class="label" style="margin:0; font-weight:600;">{{ shippingBadgeText }}</p>
        </div>
        <p class="sub" style="margin:0; font-style:italic; color:#6b3f12;">
          {{ shippingMessageDetail }}
        </p>
      </div>

      <div class="suggestions" *ngIf="suggestions.length">
        <p class="eyebrow">Te puede interesar</p>
        <div class="suggestion-list">
          <div
            class="suggestion-card"
            *ngFor="let prod of suggestions; trackBy: trackProduct"
          >
            <img [src]="prod.imagen" [alt]="prod.nombre" loading="lazy" />
            <div class="info">
              <p class="title">{{ prod.nombre }}</p>
              <p class="meta">{{ prod.coleccion }} · {{ prod.categoria }}</p>
              <p class="price">{{ formatPrice(prod.precio) }}</p>
            </div>
            <button type="button" class="mini" (click)="addSuggested(prod)">
              Agregar
            </button>
          </div>
        </div>
      </div>

      <div class="security-badge">
        <i class="fas fa-lock"></i>
        <div>
          <strong>Pago Seguro</strong>
          <p>Transaccion protegida con Wompi</p>
        </div>
      </div>
    </div>
  </div>
</div>

