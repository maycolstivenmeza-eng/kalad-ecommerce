<div class="admin-container analytics-container">
  <div class="admin-header">
    <h2>Analítica de interacción</h2>
    <div class="admin-header-actions">
      <button type="button" class="btn-reset" (click)="irADashboard()" title="Panel de ventas">
        Panel de ventas
      </button>
      <button type="button" class="btn-reset" (click)="irAProductos()" title="Gestión de productos">
        Productos
      </button>
      <button type="button" class="btn-reset" (click)="irAPedidos()" title="Gestión de pedidos">
        Pedidos
      </button>
      <button (click)="logout()" class="logout-btn" title="Cerrar sesión">
        Cerrar sesión
      </button>
    </div>
  </div>

  <div class="alert error" *ngIf="error">
    {{ error }}
  </div>

  <div class="filtros-bar analytics-filtros">
    <div>
      <label for="filtroRango">Rango</label>
      <select
        id="filtroRango"
        [(ngModel)]="selectedRange"
        (ngModelChange)="refresh()"
      >
        <option *ngFor="let r of rangeOptions" [ngValue]="r.value">{{ r.label }}</option>
      </select>
    </div>

    <div *ngIf="selectedRange === 'custom'">
      <label for="customStart">Inicio</label>
      <input id="customStart" type="date" [(ngModel)]="customStart" (ngModelChange)="refresh()" />
    </div>

    <div *ngIf="selectedRange === 'custom'">
      <label for="customEnd">Fin</label>
      <input id="customEnd" type="date" [(ngModel)]="customEnd" (ngModelChange)="refresh()" />
    </div>

    <div>
      <label for="filtroColeccion">Colección</label>
      <select
        id="filtroColeccion"
        [(ngModel)]="selectedCollection"
        (ngModelChange)="refresh()"
      >
        <option *ngFor="let c of collections" [ngValue]="c.value">
          {{ c.label }}
        </option>
      </select>
    </div>

    <div>
      <label for="filtroSource">Source</label>
      <select
        id="filtroSource"
        [(ngModel)]="selectedSource"
        (ngModelChange)="refresh()"
      >
        <option *ngFor="let s of sources" [ngValue]="s.value">
          {{ s.label }}
        </option>
      </select>
    </div>

    <div class="filters-actions">
      <label>&nbsp;</label>
      <div class="filters-actions-row">
        <button type="button" class="btn-reset" (click)="resetFilters()">Limpiar</button>
        <button type="button" class="btn-reset" (click)="exportCsv()" [disabled]="!rows.length">
          Exportar CSV
        </button>
      </div>
    </div>
  </div>

  <p class="filtro-resultado" *ngIf="!loading && rows.length">
    Mostrando {{ rows.length }} productos entre {{ dateRangeLabel }}.
  </p>

  <div class="dashboard-grid" *ngIf="!loading">
    <section class="card kpi-panel">
      <div class="card-header">
        <div>
          <h3>Resumen general</h3>
          <p>KPIs del periodo seleccionado vs rango anterior.</p>
        </div>
        <span class="pill">Interacciones</span>
      </div>
      <div class="kpi-grid kpi-grid-dashboard">
        <div class="kpi-card">
          <span class="kpi-label">Total vistas</span>
          <strong>{{ kpis.views | number }}</strong>
          <span class="kpi-delta">vs anterior: {{ deltaPercent(kpis.views, prevKpis.views) }}</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Agregados al carrito</span>
          <strong>{{ kpis.addToCart | number }}</strong>
          <span class="kpi-delta">vs anterior: {{ deltaPercent(kpis.addToCart, prevKpis.addToCart) }}</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Eliminados del carrito</span>
          <strong>{{ kpis.removeFromCart | number }}</strong>
          <span class="kpi-delta">vs anterior: {{ deltaPercent(kpis.removeFromCart, prevKpis.removeFromCart) }}</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Inicios de checkout</span>
          <strong>{{ kpis.beginCheckout | number }}</strong>
          <span class="kpi-delta">vs anterior: {{ deltaPercent(kpis.beginCheckout, prevKpis.beginCheckout) }}</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Compras</span>
          <strong>{{ kpis.purchases | number }}</strong>
          <span class="kpi-delta">vs anterior: {{ deltaPercent(kpis.purchases, prevKpis.purchases) }}</span>
        </div>
      </div>
    </section>

    <section class="card chart-card">
      <div class="card-header">
        <div>
          <h3>Embudo de conversión</h3>
          <p>Relación de pasos clave del usuario.</p>
        </div>
        <span class="pill">Funnel</span>
      </div>
      <div class="funnel">
        <div class="funnel-step">
          <div class="step-label">Vistas</div>
          <div class="step-bar">
            <span [style.width.%]="percent(kpis.views, kpis.views || 1)"></span>
          </div>
          <div class="step-value">{{ kpis.views | number }}</div>
        </div>
        <div class="funnel-step">
          <div class="step-label">Add to cart</div>
          <div class="step-bar">
            <span [style.width.%]="percent(kpis.addToCart, kpis.views)"></span>
          </div>
          <div class="step-value">{{ kpis.addToCart | number }}</div>
        </div>
        <div class="funnel-step">
          <div class="step-label">Checkout</div>
          <div class="step-bar">
            <span [style.width.%]="percent(kpis.beginCheckout, kpis.views)"></span>
          </div>
          <div class="step-value">{{ kpis.beginCheckout | number }}</div>
        </div>
        <div class="funnel-step">
          <div class="step-label">Compras</div>
          <div class="step-bar">
            <span [style.width.%]="percent(kpis.purchases, kpis.views)"></span>
          </div>
          <div class="step-value">{{ kpis.purchases | number }}</div>
        </div>
      </div>
    </section>

    <section class="card chart-card">
      <div class="card-header">
        <div>
          <h3>Origen de visitas (GA4)</h3>
          <p>Sesiones agrupadas por fuente/medio.</p>
        </div>
        <span class="pill">GA4</span>
      </div>
      <div class="filtro-resultado" *ngIf="ga4Loading">Cargando GA4...</div>
      <div class="alert error" *ngIf="!ga4Loading && ga4Error">{{ ga4Error }}</div>
      <p class="chart-empty" *ngIf="!ga4Loading && !ga4Error && !ga4Sources.length">
        Sin datos GA4 para el rango seleccionado.
      </p>
      <div class="bar-list" *ngIf="!ga4Loading && !ga4Error && ga4Sources.length">
        <div class="bar-row" *ngFor="let row of ga4Sources">
          <div class="bar-label">{{ row.sourceMedium }}</div>
          <div class="bar-track">
            <span [style.width.%]="percent(row.sessions, maxGa4Sessions)"></span>
          </div>
          <div class="bar-value">{{ row.sessions | number }}</div>
        </div>
      </div>
    </section>

    <section class="card chart-card">
      <div class="card-header">
        <div>
          <h3>Tráfico por red social</h3>
          <p>Sesiones GA4 agrupadas por red.</p>
        </div>
        <span class="pill">Social</span>
      </div>
      <p class="chart-empty" *ngIf="!ga4SocialTotals.length && !ga4Loading">
        Sin tráfico social detectado en el rango seleccionado.
      </p>
      <div class="bar-list" *ngIf="ga4SocialTotals.length">
        <div class="bar-row" *ngFor="let row of ga4SocialTotals">
          <div class="bar-label">{{ row.source }}</div>
          <div class="bar-track">
            <span [style.width.%]="percent(row.sessions, maxGa4SocialSessions)"></span>
          </div>
          <div class="bar-value">{{ row.sessions | number }}</div>
        </div>
      </div>
    </section>

    <section class="card chart-card">
      <div class="card-header">
        <div>
          <h3>Fuentes internas</h3>
          <p>Eventos internos agrupados por fuente.</p>
        </div>
        <span class="pill">Eventos</span>
      </div>
      <p class="chart-empty" *ngIf="!sourceTotals.length">
        Sin datos internos para el rango seleccionado.
      </p>
      <div class="bar-list" *ngIf="sourceTotals.length">
        <div class="bar-row" *ngFor="let row of sourceTotals">
          <div class="bar-label">{{ row.source }}</div>
          <div class="bar-track">
            <span [style.width.%]="percent(row.views, maxSourceViews)"></span>
          </div>
          <div class="bar-value">{{ row.views | number }}</div>
        </div>
      </div>
    </section>

    <section class="card chart-card">
      <div class="card-header">
        <div>
          <h3>Top productos por vistas</h3>
          <p>Los productos más vistos del periodo.</p>
        </div>
        <span class="pill">Vistas</span>
      </div>
      <p class="chart-empty" *ngIf="!topViews.length">Sin datos de vistas.</p>
      <div class="bar-list" *ngIf="topViews.length">
        <div class="bar-row" *ngFor="let row of topViews">
          <div class="bar-label">{{ row.nombre }}</div>
          <div class="bar-track">
            <span [style.width.%]="percent(row.views, maxViews)"></span>
          </div>
          <div class="bar-value">{{ row.views | number }}</div>
        </div>
      </div>
    </section>

    <section class="card chart-card">
      <div class="card-header">
        <div>
          <h3>Top productos por add to cart</h3>
          <p>Productos con mayor intención.</p>
        </div>
        <span class="pill">Carrito</span>
      </div>
      <p class="chart-empty" *ngIf="!topAddToCart.length">Sin datos de carrito.</p>
      <div class="bar-list" *ngIf="topAddToCart.length">
        <div class="bar-row" *ngFor="let row of topAddToCart">
          <div class="bar-label">{{ row.nombre }}</div>
          <div class="bar-track">
            <span [style.width.%]="percent(row.addToCart, maxAddToCart)"></span>
          </div>
          <div class="bar-value">{{ row.addToCart | number }}</div>
        </div>
      </div>
    </section>

    <section class="card chart-card">
      <div class="card-header">
        <div>
          <h3>Top productos por compras</h3>
          <p>Productos con mayor conversión.</p>
        </div>
        <span class="pill">Compras</span>
      </div>
      <p class="chart-empty" *ngIf="!topPurchases.length">Sin datos de compras.</p>
      <div class="bar-list" *ngIf="topPurchases.length">
        <div class="bar-row" *ngFor="let row of topPurchases">
          <div class="bar-label">{{ row.nombre }}</div>
          <div class="bar-track">
            <span [style.width.%]="percent(row.purchases, maxPurchases)"></span>
          </div>
          <div class="bar-value">{{ row.purchases | number }}</div>
        </div>
      </div>
    </section>
  </div>

  <div *ngIf="loading" class="filtro-resultado">
    Cargando analítica...
  </div>

  <div *ngIf="!loading && !rows.length" class="filtro-resultado">
    Sin datos de interacción en el rango seleccionado.
  </div>

  <details class="details-block" *ngIf="!loading && rows.length">
    <summary>Ver tablas detalladas</summary>
    <h3 class="titulo-lista">Top por fuente</h3>
    <table class="tabla-productos">
      <thead>
        <tr>
          <th>Source</th>
          <th>Views</th>
          <th>Add to cart</th>
          <th>Purchases</th>
          <th>Conversión</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of sourceTotals">
          <td>{{ row.source }}</td>
          <td>{{ row.views | number }}</td>
          <td>{{ row.addToCart | number }}</td>
          <td>{{ row.purchases | number }}</td>
          <td>{{ row.conversion | percent:'1.0-1' }}</td>
        </tr>
      </tbody>
    </table>

    <h3 class="titulo-lista">Top 10 más vistos</h3>
    <table class="tabla-productos">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Producto</th>
          <th>Colección</th>
          <th>Views</th>
          <th>Add to cart</th>
          <th>Tasa intención</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of topViews">
          <td>
            <img *ngIf="row.imagen" [src]="row.imagen" [alt]="row.nombre" class="img-tabla" loading="lazy" />
            <span *ngIf="!row.imagen" class="sin-imagen">-</span>
          </td>
          <td>{{ row.nombre }}</td>
          <td>{{ row.coleccion || 'Sin colección' }}</td>
          <td>{{ row.views | number }}</td>
          <td>{{ row.addToCart | number }}</td>
          <td>{{ row.tasaIntencion | percent:'1.0-1' }}</td>
        </tr>
      </tbody>
    </table>

    <h3 class="titulo-lista">Top 10 más agregados al carrito</h3>
    <table class="tabla-productos">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Producto</th>
          <th>Colección</th>
          <th>Add to cart</th>
          <th>Views</th>
          <th>Tasa intención</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of topAddToCart">
          <td>
            <img *ngIf="row.imagen" [src]="row.imagen" [alt]="row.nombre" class="img-tabla" loading="lazy" />
            <span *ngIf="!row.imagen" class="sin-imagen">-</span>
          </td>
          <td>{{ row.nombre }}</td>
          <td>{{ row.coleccion || 'Sin colección' }}</td>
          <td>{{ row.addToCart | number }}</td>
          <td>{{ row.views | number }}</td>
          <td>{{ row.tasaIntencion | percent:'1.0-1' }}</td>
        </tr>
      </tbody>
    </table>

    <h3 class="titulo-lista">Top 10 por compras</h3>
    <table class="tabla-productos">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Producto</th>
          <th>Colección</th>
          <th>Purchases</th>
          <th>Views</th>
          <th>Conversión</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of topPurchases">
          <td>
            <img *ngIf="row.imagen" [src]="row.imagen" [alt]="row.nombre" class="img-tabla" loading="lazy" />
            <span *ngIf="!row.imagen" class="sin-imagen">-</span>
          </td>
          <td>{{ row.nombre }}</td>
          <td>{{ row.coleccion || 'Sin colección' }}</td>
          <td>{{ row.purchases | number }}</td>
          <td>{{ row.views | number }}</td>
          <td>{{ row.tasaConversion | percent:'1.0-1' }}</td>
        </tr>
      </tbody>
    </table>

    <h3 class="titulo-lista">Top 10 por tasa de intención</h3>
    <table class="tabla-productos">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Producto</th>
          <th>Colección</th>
          <th>Tasa intención</th>
          <th>Add to cart</th>
          <th>Views</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of topIntention">
          <td>
            <img *ngIf="row.imagen" [src]="row.imagen" [alt]="row.nombre" class="img-tabla" loading="lazy" />
            <span *ngIf="!row.imagen" class="sin-imagen">-</span>
          </td>
          <td>{{ row.nombre }}</td>
          <td>{{ row.coleccion || 'Sin colección' }}</td>
          <td>{{ row.tasaIntencion | percent:'1.0-1' }}</td>
          <td>{{ row.addToCart | number }}</td>
          <td>{{ row.views | number }}</td>
        </tr>
      </tbody>
    </table>

    <h3 class="titulo-lista">Top 10 por tasa de conversión</h3>
    <table class="tabla-productos">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Producto</th>
          <th>Colección</th>
          <th>Conversión</th>
          <th>Purchases</th>
          <th>Views</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of topConversion">
          <td>
            <img *ngIf="row.imagen" [src]="row.imagen" [alt]="row.nombre" class="img-tabla" loading="lazy" />
            <span *ngIf="!row.imagen" class="sin-imagen">-</span>
          </td>
          <td>{{ row.nombre }}</td>
          <td>{{ row.coleccion || 'Sin colección' }}</td>
          <td>{{ row.tasaConversion | percent:'1.0-1' }}</td>
          <td>{{ row.purchases | number }}</td>
          <td>{{ row.views | number }}</td>
        </tr>
      </tbody>
    </table>

    <h3 class="titulo-lista">Tráfico perdido (muchas views, baja conversión)</h3>
    <table class="tabla-productos">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Producto</th>
          <th>Colección</th>
          <th>Views</th>
          <th>Purchases</th>
          <th>Conversión</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of topLowConversion">
          <td>
            <img *ngIf="row.imagen" [src]="row.imagen" [alt]="row.nombre" class="img-tabla" loading="lazy" />
            <span *ngIf="!row.imagen" class="sin-imagen">-</span>
          </td>
          <td>{{ row.nombre }}</td>
          <td>{{ row.coleccion || 'Sin colección' }}</td>
          <td>{{ row.views | number }}</td>
          <td>{{ row.purchases | number }}</td>
          <td>{{ row.tasaConversion | percent:'1.0-1' }}</td>
        </tr>
      </tbody>
    </table>
  </details>
</div>
