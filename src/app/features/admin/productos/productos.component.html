<div class="admin-container">

  <!-- HEADER ADMIN -->
  <div class="admin-header">
    <h2>Gestión de productos</h2>
    <button (click)="logout()" class="logout-btn" title="Cerrar sesión">
      Cerrar sesión
    </button>
  </div>

  <div class="alert" *ngIf="mensajeSistema" [ngClass]="mensajeSistema.tipo">
    {{ mensajeSistema.texto }}
  </div>

  <form #adminForm="ngForm" novalidate (ngSubmit)="guardarProducto(adminForm)">

    <!-- NOMBRE -->
    <label for="nombre">Nombre del producto</label>
    <input id="nombre" type="text" name="nombre" [(ngModel)]="producto.nombre" required maxlength="80" class="input"/>

    <!-- PRECIO -->
    <label for="precio">Precio</label>
    <input
      id="precio"
      type="text"
      name="precio"
      inputmode="decimal"
      autocomplete="off"
      [(ngModel)]="producto.precio"
      required
      placeholder="Ej: 78.000"
      class="input"
    />

    <!-- BADGE -->
    <label for="badge">Etiqueta (badge)</label>
    <select id="badge" name="badge" [(ngModel)]="producto.badge" class="input">
      <option *ngFor="let badge of badges" [ngValue]="badge">{{ badge || 'Sin etiqueta' }}</option>
    </select>

    <!-- CATEGORÍA -->
    <label for="categoria">Categoría</label>
    <select id="categoria" name="categoria" [(ngModel)]="producto.categoria" required class="input">
      <option value="" disabled>Selecciona una categoría</option>
      <option *ngFor="let categoria of categorias" [value]="categoria">{{ categoria }}</option>
    </select>

    <!-- COLECCIÓN -->
    <label for="coleccion">Colección</label>
    <select id="coleccion" name="coleccion" [(ngModel)]="producto.coleccion" required class="input">
      <option *ngFor="let coleccion of colecciones" [value]="coleccion.id">{{ coleccion.label }}</option>
    </select>

    <!-- COLORES -->
    <label for="colores">Colores (separados por coma)</label>
    <input id="colores" type="text" name="colores" [(ngModel)]="producto.coloresTexto" placeholder="Beige, Café, Arena" class="input"/>

    <!-- STOCK -->
    <label for="stock">Stock disponible</label>
    <input id="stock" type="number" name="stock" [(ngModel)]="producto.stock" required min="0" class="input"/>

    <!-- DESCRIPCIÓN -->
    <label for="descripcion">Descripción</label>
    <textarea id="descripcion" name="descripcion" [(ngModel)]="producto.descripcion" required rows="4" class="input"></textarea>

    <!-- CARACTERÍSTICAS -->
    <label for="caracteristicas">Características destacadas</label>
    <textarea
      id="caracteristicas"
      name="caracteristicas"
      [(ngModel)]="producto.caracteristicas"
      rows="4"
      class="input"
      placeholder="Materiales, proceso artesanal, beneficios, etc."
    ></textarea>

    <!-- DIMENSIONES -->
    <fieldset class="dimensiones-fieldset">
      <legend>Dimensiones del producto</legend>
      <div class="dimensiones-grid">
        <label for="dimAlto">Alto</label>
        <input
          id="dimAlto"
          type="text"
          name="dimAlto"
          [(ngModel)]="producto.dimensiones.alto"
          class="input"
          placeholder="18 cm"
        />

        <label for="dimAncho">Ancho</label>
        <input
          id="dimAncho"
          type="text"
          name="dimAncho"
          [(ngModel)]="producto.dimensiones.ancho"
          class="input"
          placeholder="22 cm"
        />

        <label for="dimProfundidad">Profundidad</label>
        <input
          id="dimProfundidad"
          type="text"
          name="dimProfundidad"
          [(ngModel)]="producto.dimensiones.profundidad"
          class="input"
          placeholder="7 cm"
        />

        <label for="dimCapacidad">Capacidad</label>
        <input
          id="dimCapacidad"
          type="text"
          name="dimCapacidad"
          [(ngModel)]="producto.dimensiones.capacidad"
          class="input"
          placeholder="4 L"
        />
      </div>
    </fieldset>

    <!-- IMAGEN PRINCIPAL -->
    <label for="imagen">Imagen principal del producto</label>
    <input id="imagen" type="file" (change)="seleccionarImagen($event)" accept="image/*" class="input" [required]="!modoEdicion"/>

    <p class="input-hint error" *ngIf="faltaImagenPrincipal()">
      Debes seleccionar una imagen principal para crear el producto.
    </p>

    <!-- PREVIEW IMAGEN PRINCIPAL -->
    <div class="preview-container" *ngIf="previewUrl">
      <img [src]="previewUrl" class="preview-img"/>
      <button type="button" class="btn-eliminar-img" (click)="limpiarImagen()">Eliminar imagen</button>
    </div>

    <!-- IMÁGENES SECUNDARIAS -->
    <label for="imagenesSec">Imágenes adicionales (máximo 4)</label>
    <input id="imagenesSec" type="file" multiple accept="image/*" (change)="seleccionarMultiplesImagenes($event)" class="input"/>

    <div class="preview-multiplas" *ngIf="previewImagenes.length > 0">
      <div class="preview-multi-item" *ngFor="let img of previewImagenes; let i = index">
        <img [src]="img" class="preview-multi-img"/>
        <button type="button" class="preview-multi-delete" (click)="eliminarImagenSecundaria(i)">✕</button>
      </div>
    </div>

    <!-- BOTÓN GUARDAR -->
    <button class="btn-guardar" type="submit" [disabled]="adminForm.invalid || faltaImagenPrincipal() || guardando">
      {{ guardando ? textoBotonProcesando : textoBotonAccion }}
    </button>

  </form>

  <!-- FILTROS -->
  <div class="filtros-bar">
    <input
      type="text"
      placeholder="Buscar por nombre"
      [(ngModel)]="filtroNombre"
      (ngModelChange)="aplicarFiltros()"
    />

    <select [(ngModel)]="filtroCategoria" (ngModelChange)="aplicarFiltros()">
      <option value="">Todas las categorías</option>
      <option *ngFor="let categoria of categorias" [value]="categoria">
        {{ categoria }}
      </option>
    </select>

    <select [(ngModel)]="filtroColeccion" (ngModelChange)="aplicarFiltros()">
      <option value="">Todas las colecciones</option>
      <option *ngFor="let coleccion of colecciones" [value]="coleccion.id">
        {{ coleccion.label }}
      </option>
    </select>

    <select [(ngModel)]="filtroBadge" (ngModelChange)="aplicarFiltros()">
      <option value="">Todas las etiquetas</option>
      <option *ngFor="let badge of badges" [ngValue]="badge">
        {{ badge || 'Sin etiqueta' }}
      </option>
    </select>

    <button type="button" class="btn-reset" (click)="resetFiltros()">Limpiar</button>
  </div>

  <p class="filtro-resultado">
    Mostrando {{ productosFiltrados.length }} de {{ productos.length }} productos
  </p>

  <h3 class="titulo-lista">Productos Registrados</h3>

  <ng-container *ngIf="productosFiltrados.length; else sinProductos">
    <table class="tabla-productos">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Categoría</th>
          <th>Colección</th>
          <th>Badge</th>
          <th>Stock</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let prod of productosFiltrados">
          <td>
            <ng-container *ngIf="obtenerImagenProducto(prod) as imagen; else sinImagenTpl">
              <img [src]="imagen" [alt]="prod.nombre" class="img-tabla" />
            </ng-container>
          </td>
          <td>{{ prod.nombre }}</td>
          <td>{{ prod.precio | currency:'COP':'symbol':'1.0-0' }}</td>
          <td>{{ prod.categoria }}</td>
          <td>{{ prod.coleccion }}</td>
          <td>{{ prod.badge || '-' }}</td>
          <td>{{ prod.stock }}</td>
          <td>
            <div class="acciones">
              <button type="button" class="btn-editar" (click)="editarProducto(prod)">Editar</button>
              <button type="button" class="btn-eliminar" (click)="eliminarProducto(prod.id)">Eliminar</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </ng-container>

  <ng-template #sinImagenTpl>
    <span class="sin-imagen">-</span>
  </ng-template>

  <ng-template #sinProductos>
    <p class="filtro-resultado">No hay productos registrados todavía.</p>
  </ng-template>
</div>

<div
  class="toast-notification"
  *ngIf="toastActivo"
  [ngClass]="toastActivo.tipo"
  role="status"
  aria-live="assertive"
>
  {{ toastActivo.texto }}
</div>
