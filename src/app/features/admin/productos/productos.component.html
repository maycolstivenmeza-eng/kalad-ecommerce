<div class="admin-container">

  <!-- HEADER ADMIN -->
  <div class="admin-header">
    <h2>Gestion de productos</h2>
    <button (click)="logout()" class="logout-btn" title="Cerrar sesion">
      Cerrar sesion
    </button>
  </div>

  <div class="alert" *ngIf="mensajeSistema" [ngClass]="mensajeSistema.tipo">
    {{ mensajeSistema.texto }}
  </div>

  <form #adminForm="ngForm" novalidate (ngSubmit)="guardarProducto(adminForm)">

    <!-- NOMBRE -->
    <label for="nombre">Nombre del producto</label>
    <input id="nombre" type="text" name="nombre" [(ngModel)]="producto.nombre" required maxlength="80" class="input"/>

    <!-- PRECIO -->
    <label for="precio">Precio</label>
    <input
      id="precio"
      type="text"
      name="precio"
      inputmode="decimal"
      autocomplete="off"
      [(ngModel)]="producto.precio"
      required
      placeholder="Ej: 78.000"
      class="input"
    />

    <!-- BADGE -->
    <label for="badge">Etiqueta (badge)</label>
    <select id="badge" name="badge" [(ngModel)]="producto.badge" class="input">
      <option *ngFor="let badge of badges" [ngValue]="badge">{{ badge || 'Sin etiqueta' }}</option>
    </select>

    <!-- Estatus -->
    <label class="switch-row">
      <input type="checkbox" [(ngModel)]="producto.activo" name="activo" />
      <span>Producto activo</span>
    </label>

    <!-- CATEGORIA -->
    <label for="categoria">Categoria</label>
    <select id="categoria" name="categoria" [(ngModel)]="producto.categoria" required class="input">
      <option value="" disabled>Selecciona una categoria</option>
      <option *ngFor="let categoria of categorias" [value]="categoria">{{ categoria }}</option>
    </select>

    <!-- COLECCION -->
    <label for="coleccion">Coleccion</label>
    <select id="coleccion" name="coleccion" [(ngModel)]="producto.coleccion" required class="input">
      <option *ngFor="let coleccion of colecciones" [value]="coleccion.id">{{ coleccion.label }}</option>
    </select>

    <!-- COLORES -->
    <label for="colores">Colores (separados por coma)</label>
    <input id="colores" type="text" name="colores" [(ngModel)]="producto.coloresTexto" placeholder="Beige, Cafe, Arena" class="input"/>

    <!-- STOCK -->
    <label for="stock">Stock disponible</label>
    <input id="stock" type="number" name="stock" [(ngModel)]="producto.stock" required min="0" class="input"/>

    <!-- DESCRIPCION -->
    <label for="descripcion">Descripcion</label>
    <textarea id="descripcion" name="descripcion" [(ngModel)]="producto.descripcion" required rows="4" class="input"></textarea>

    <!-- CARACTERISTICAS -->
    <label for="caracteristicas">Caracteristicas destacadas</label>
    <textarea
      id="caracteristicas"
      name="caracteristicas"
      [(ngModel)]="producto.caracteristicas"
      rows="4"
      class="input"
      placeholder="Materiales, proceso artesanal, beneficios, etc."
    ></textarea>

    <!-- DIMENSIONES -->
    <fieldset class="dimensiones-fieldset">
      <legend>Dimensiones del producto</legend>
      <div class="dimensiones-grid">
        <label for="dimAlto">Alto</label>
        <input
          id="dimAlto"
          type="text"
          name="dimAlto"
          [(ngModel)]="producto.dimensiones.alto"
          class="input"
          placeholder="18 cm"
        />

        <label for="dimAncho">Ancho</label>
        <input
          id="dimAncho"
          type="text"
          name="dimAncho"
          [(ngModel)]="producto.dimensiones.ancho"
          class="input"
          placeholder="22 cm"
        />

        <label for="dimProfundidad">Profundidad</label>
        <input
          id="dimProfundidad"
          type="text"
          name="dimProfundidad"
          [(ngModel)]="producto.dimensiones.profundidad"
          class="input"
          placeholder="7 cm"
        />

        <label for="dimCapacidad">Capacidad</label>
        <input
          id="dimCapacidad"
          type="text"
          name="dimCapacidad"
          [(ngModel)]="producto.dimensiones.capacidad"
          class="input"
          placeholder="4 L"
        />
      </div>
    </fieldset>

    <!-- IMAGEN PRINCIPAL -->
    <label for="imagen">Imagen principal del producto</label>
    <input id="imagen" type="file" (change)="seleccionarImagen($event)" accept="image/*" class="input" [required]="!modoEdicion"/>

    <p class="input-hint error" *ngIf="faltaImagenPrincipal()">
      Debes seleccionar una imagen principal para crear el producto.
    </p>

    <!-- PREVIEW IMAGEN PRINCIPAL -->
    <div class="preview-container" *ngIf="previewUrl">
      <img [src]="previewUrl" class="preview-img"/>
      <button type="button" class="btn-eliminar-img" (click)="limpiarImagen()">Eliminar imagen</button>
    </div>

    <!-- IMAGENES SECUNDARIAS -->
    <label for="imagenesSec">Imagenes adicionales (maximo 4)</label>
    <input id="imagenesSec" type="file" multiple accept="image/*" (change)="seleccionarMultiplesImagenes($event)" class="input"/>

    <div class="preview-multiplas" *ngIf="previewImagenes.length > 0">
      <div class="preview-multi-item" *ngFor="let img of previewImagenes; let i = index">
        <img [src]="img" class="preview-multi-img"/>
        <button type="button" class="preview-multi-delete" (click)="eliminarImagenSecundaria(i)">x</button>
      </div>
    </div>

    <!-- BOTON GUARDAR -->
    <button class="btn-guardar" type="submit" [disabled]="adminForm.invalid || faltaImagenPrincipal() || guardando">
      {{ guardando ? textoBotonProcesando : textoBotonAccion }}
    </button>

  </form>

  <!-- FILTROS -->
  <div class="filtros-bar">
    <input
      type="text"
      placeholder="Buscar por nombre"
      [(ngModel)]="filtroNombre"
      (ngModelChange)="aplicarFiltros()"
    />

    <select [(ngModel)]="filtroCategoria" (ngModelChange)="aplicarFiltros()">
      <option value="">Todas las categorias</option>
      <option *ngFor="let categoria of categorias" [value]="categoria">
        {{ categoria }}
      </option>
    </select>

    <select [(ngModel)]="filtroColeccion" (ngModelChange)="aplicarFiltros()">
      <option value="">Todas las colecciones</option>
      <option *ngFor="let coleccion of colecciones" [value]="coleccion.id">
        {{ coleccion.label }}
      </option>
    </select>

    <select [(ngModel)]="filtroBadge" (ngModelChange)="aplicarFiltros()">
      <option value="">Todas las etiquetas</option>
      <option *ngFor="let badge of badges" [ngValue]="badge">
        {{ badge || 'Sin etiqueta' }}
      </option>
    </select>

    <button type="button" class="btn-reset" (click)="resetFiltros()">Limpiar</button>
  </div>

  <p class="filtro-resultado">
    Mostrando {{ productosFiltrados.length }} de {{ productos.length }} productos
  </p>

  <h3 class="titulo-lista">Productos Registrados</h3>

  <ng-container *ngIf="productosFiltrados.length; else sinProductos">
    <table class="tabla-productos">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Categoria</th>
          <th>Coleccion</th>
          <th>Badge</th>
          <th>Stock</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let prod of productosFiltrados">
          <td>
            <ng-container *ngIf="obtenerImagenProducto(prod) as imagen; else sinImagenTpl">
              <img [src]="imagen" [alt]="prod.nombre" class="img-tabla" />
            </ng-container>
          </td>
          <td>{{ prod.nombre }}</td>
          <td>{{ prod.precio | currency:'COP':'symbol':'1.0-0' }}</td>
          <td>{{ prod.categoria }}</td>
          <td>{{ prod.coleccion }}</td>
          <td>{{ prod.badge || '-' }}</td>
          <td>{{ prod.stock }}</td>
          <td>
            <span class="pill" [class.off]="!(prod.activo ?? true)">
              {{ (prod.activo ?? true) ? 'Activo' : 'Inactivo' }}
            </span>
          </td>
          <td>
            <div class="acciones">
              <button type="button" class="btn-editar" (click)="editarProducto(prod)">Editar</button>
              <button type="button" class="btn-eliminar" (click)="eliminarProducto(prod.id)">Eliminar</button>
              <button type="button" class="btn-toggle" (click)="toggleActivo(prod)">
                {{ (prod.activo ?? true) ? 'Desactivar' : 'Activar' }}
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </ng-container>

  <ng-template #sinImagenTpl>
    <span class="sin-imagen">-</span>
  </ng-template>

  <ng-template #sinProductos>
    <p class="filtro-resultado">No hay productos registrados todavia.</p>
  </ng-template>

  <h3 class="titulo-lista">Pedidos</h3>
  <div class="pedidos" *ngIf="pedidos.length; else sinPedidos">
    <table class="tabla-productos">
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Total</th>
          <th>Estado</th>
          <th>Cambiar estado</th>
          <th>Guia envio</th>
          <th>Nota admin</th>
          <th>Items</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of pedidos">
          <td>{{ p.id }}</td>
          <td>{{ p.userId }}</td>
          <td>{{ p.total | currency:'COP':'symbol':'1.0-0' }}</td>
          <td>{{ p.estado }}</td>
          <td>
            <select [ngModel]="p.estado" (ngModelChange)="cambiarEstadoPedido(p, $event)">
              <option *ngFor="let e of estadosPedido" [value]="e">{{ e }}</option>
            </select>
          </td>
          <td><input class="mini-input" type="text" [(ngModel)]="p.guiaEnvio" placeholder="Guia" /></td>
          <td><input class="mini-input" type="text" [(ngModel)]="p.notaAdmin" placeholder="Nota" /></td>
          <td>{{ p.items.length || 0 }}</td>
          <td>{{ p.createdAt?.toDate ? (p.createdAt.toDate() | date:'short') : '-' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
  <ng-template #sinPedidos>
    <p class="filtro-resultado">No hay pedidos registrados.</p>
  </ng-template>
</div>

<div
  class="toast-notification"
  *ngIf="toastActivo"
  [ngClass]="toastActivo.tipo"
  role="status"
  aria-live="assertive"
>
  {{ toastActivo.texto }}
</div>
