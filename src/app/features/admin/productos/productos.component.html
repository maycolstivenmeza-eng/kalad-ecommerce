<div class="admin-container">

  <!-- HEADER ADMIN -->
  <div class="admin-header">
    <h2>Gestión de productos</h2>
    <div class="admin-header-actions">
      <button type="button" class="btn-reset" (click)="irAPedidos()" title="Ver pedidos">
        Ver pedidos
      </button>
      <button (click)="logout()" class="logout-btn" title="Cerrar sesión">
        Cerrar sesión
      </button>
    </div>
  </div>

  <div class="alert" *ngIf="mensajeSistema" [ngClass]="mensajeSistema.tipo">
    {{ mensajeSistema.texto }}
  </div>

  <form #adminForm="ngForm" novalidate (ngSubmit)="guardarProducto(adminForm)">

    <!-- NOMBRE -->
    <label for="nombre">Nombre del producto</label>
    <input id="nombre" type="text" name="nombre" [(ngModel)]="producto.nombre" required maxlength="80" class="input"/>

    <!-- PRECIO -->
    <label for="precio">Precio</label>
    <input
      id="precio"
      type="text"
      name="precio"
      inputmode="decimal"
      autocomplete="off"
      [(ngModel)]="producto.precio"
      required
      placeholder="Ej: 78.000"
      class="input"
    />

    <!-- BADGE -->
    <label for="badge">Etiqueta (badge)</label>
    <select id="badge" name="badge" [(ngModel)]="producto.badge" class="input">
      <option *ngFor="let badge of badges" [ngValue]="badge">{{ badge || 'Sin etiqueta' }}</option>
    </select>

    <!-- Estatus -->
    <label class="switch-row">
      <input type="checkbox" [(ngModel)]="producto.activo" name="activo" />
      <span>Producto activo</span>
    </label>

    <!-- CATEGORIA -->
    <label for="categoria">Categoria</label>
    <select id="categoria" name="categoria" [(ngModel)]="producto.categoria" required class="input">
      <option value="" disabled>Selecciona una categoria</option>
      <option *ngFor="let categoria of categorias" [value]="categoria">{{ categoria }}</option>
    </select>

    <!-- COLECCION -->
    <label for="coleccion">Coleccion</label>
    <select id="coleccion" name="coleccion" [(ngModel)]="producto.coleccion" required class="input">
      <option *ngFor="let coleccion of colecciones" [value]="coleccion.id">{{ coleccion.label }}</option>
    </select>

    <!-- COLORES -->
    <label for="colores">Colores (separados por coma)</label>
    <input id="colores" type="text" name="colores" [(ngModel)]="producto.coloresTexto" placeholder="Beige, Cafe, Arena" class="input"/>

    <!-- STOCK -->
    <label for="stock">Stock disponible</label>
    <input id="stock" type="number" name="stock" [(ngModel)]="producto.stock" required min="0" class="input"/>

    <!-- DESCRIPCION -->
    <label for="descripcion">Descripcion</label>
    <textarea id="descripcion" name="descripcion" [(ngModel)]="producto.descripcion" required rows="4" class="input"></textarea>

    <!-- CARACTERISTICAS -->
    <label for="caracteristicas">Caracteristicas destacadas</label>
    <textarea
      id="caracteristicas"
      name="caracteristicas"
      [(ngModel)]="producto.caracteristicas"
      rows="4"
      class="input"
      placeholder="Materiales, proceso artesanal, beneficios, etc."
    ></textarea>

    <!-- DIMENSIONES -->
    <fieldset class="dimensiones-fieldset">
      <legend>Dimensiones del producto</legend>
      <div class="dimensiones-grid">
        <label for="dimAlto">Alto</label>
        <input
          id="dimAlto"
          type="text"
          name="dimAlto"
          [(ngModel)]="producto.dimensiones.alto"
          class="input"
          placeholder="18 cm"
        />

        <label for="dimAncho">Ancho</label>
        <input
          id="dimAncho"
          type="text"
          name="dimAncho"
          [(ngModel)]="producto.dimensiones.ancho"
          class="input"
          placeholder="22 cm"
        />

        <label for="dimProfundidad">Profundidad</label>
        <input
          id="dimProfundidad"
          type="text"
          name="dimProfundidad"
          [(ngModel)]="producto.dimensiones.profundidad"
          class="input"
          placeholder="7 cm"
        />

        <label for="dimCapacidad">Capacidad</label>
        <input
          id="dimCapacidad"
          type="text"
          name="dimCapacidad"
          [(ngModel)]="producto.dimensiones.capacidad"
          class="input"
          placeholder="4 L"
        />
      </div>
    </fieldset>

    <!-- IMAGEN PRINCIPAL -->
    <label for="imagen">Imagen principal del producto</label>
    <input id="imagen" type="file" (change)="seleccionarImagen($event)" accept="image/*" class="input" [required]="!modoEdicion"/>

    <p class="input-hint error" *ngIf="faltaImagenPrincipal()">
      Debes seleccionar una imagen principal para crear el producto.
    </p>

    <!-- PREVIEW IMAGEN PRINCIPAL -->
    <div class="preview-container" *ngIf="previewUrl">
      <img [src]="previewUrl" class="preview-img" loading="lazy"/>
      <button type="button" class="btn-eliminar-img" (click)="limpiarImagen()">Eliminar imagen</button>
    </div>

    <!-- IMAGENES SECUNDARIAS -->
    <label for="imagenesSec">Imagenes adicionales (maximo 4)</label>
    <input
      id="imagenesSec"
      type="file"
      (change)="seleccionarMultiplesImagenes($event)"
      accept="image/*"
      multiple
      class="input"
    />

    <p class="input-hint">
      Recomendacion: Usa imagenes cuadradas o verticales de buena resolucion, en formato JPG o WebP.
    </p>

    <!-- PREVIEW IMAGENES SECUNDARIAS -->
    <div class="preview-multiplas" *ngIf="previewImagenes.length">
      <div class="preview-multi-item" *ngFor="let img of previewImagenes; let i = index">
        <img [src]="img" alt="Imagen adicional {{ i + 1 }}" class="preview-multi-img" loading="lazy"/>
        <button type="button" class="preview-multi-delete" (click)="eliminarImagenSecundaria(i)">×</button>
      </div>
    </div>

    <!-- BOTON GUARDAR -->
    <button type="submit" class="btn-guardar" [disabled]="adminForm.invalid || guardando">
      {{ guardando ? textoBotonProcesando : textoBotonAccion }}
    </button>
  </form>

  <!-- FILTROS -->
  <h3 class="titulo-lista">Productos Registrados</h3>

  <div class="filtros-bar">
    <div>
      <label for="filtroNombre">Buscar por nombre</label>
      <input
        id="filtroNombre"
        type="text"
        [(ngModel)]="filtroNombre"
        (ngModelChange)="aplicarFiltros()"
        placeholder="Nombre del producto"
      />
    </div>

    <div>
      <label for="filtroCategoria">Categoria</label>
      <select
        id="filtroCategoria"
        [(ngModel)]="filtroCategoria"
        (ngModelChange)="aplicarFiltros()"
      >
        <option value="">Todas</option>
        <option *ngFor="let categoria of categorias" [value]="categoria">{{ categoria }}</option>
      </select>
    </div>

    <div>
      <label for="filtroColeccion">Coleccion</label>
      <select
        id="filtroColeccion"
        [(ngModel)]="filtroColeccion"
        (ngModelChange)="aplicarFiltros()"
      >
        <option value="">Todas</option>
        <option *ngFor="let coleccion of colecciones" [value]="coleccion.id">
          {{ coleccion.label }}
        </option>
      </select>
    </div>

    <div>
      <label for="filtroBadge">Etiqueta</label>
      <select
        id="filtroBadge"
        [(ngModel)]="filtroBadge"
        (ngModelChange)="aplicarFiltros()"
      >
        <option value="">Todas</option>
        <option *ngFor="let badge of badges" [ngValue]="badge">
          {{ badge || 'Sin etiqueta' }}
        </option>
      </select>
    </div>

    <div>
      <label>&nbsp;</label>
      <button type="button" class="btn-reset" (click)="resetFiltros()">Limpiar</button>
    </div>
  </div>

  <p class="filtro-resultado">
    Mostrando {{ productosFiltrados.length }} de {{ productos.length }} productos.
  </p>

  <!-- TABLA PRODUCTOS -->
  <ng-container *ngIf="productosFiltrados.length; else sinProductos">
    <table class="tabla-productos">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Categoria</th>
          <th>Coleccion</th>
          <th>Badge</th>
          <th>Stock</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let prod of productosFiltrados">
          <td>
            <ng-container *ngIf="obtenerImagenProducto(prod) as imagen; else sinImagenTpl">
              <img [src]="imagen" [alt]="prod.nombre" class="img-tabla" loading="lazy" />
            </ng-container>
          </td>
          <td>{{ prod.nombre }}</td>
          <td>{{ prod.precio | currency:'COP':'symbol':'1.0-0' }}</td>
          <td>{{ prod.categoria }}</td>
          <td>{{ prod.coleccion }}</td>
          <td>{{ prod.badge || '-' }}</td>
          <td>{{ prod.stock }}</td>
          <td>
            <span class="pill" [class.off]="!(prod.activo ?? true)">
              {{ (prod.activo ?? true) ? 'Activo' : 'Inactivo' }}
            </span>
          </td>
          <td>
            <div class="acciones">
              <button type="button" class="btn-editar" (click)="editarProducto(prod)">Editar</button>
              <button type="button" class="btn-eliminar" (click)="eliminarProducto(prod.id)">Eliminar</button>
              <button type="button" class="btn-toggle" (click)="toggleActivo(prod)">
                {{ (prod.activo ?? true) ? 'Desactivar' : 'Activar' }}
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </ng-container>

  <ng-template #sinImagenTpl>
    <span class="sin-imagen">-</span>
  </ng-template>

  <ng-template #sinProductos>
    <p class="filtro-resultado">No hay productos registrados todavia.</p>
  </ng-template>

  <!-- CUPONES -->
  <h3 class="titulo-lista">Cupones</h3>

  <form class="cupon-form" #cuponForm="ngForm" (ngSubmit)="guardarCupon(cuponForm)">
    <div class="cupon-grid">
      <div>
        <label for="codigoCupon">Código</label>
        <input
          id="codigoCupon"
          name="codigoCupon"
          type="text"
          [(ngModel)]="cuponEnEdicion.codigo"
          required
          maxlength="20"
          class="input"
          placeholder="KALAD10"
        />
      </div>

      <div>
        <label for="porcentajeCupon">Descuento (%)</label>
        <input
          id="porcentajeCupon"
          name="porcentajeCupon"
          type="number"
          min="1"
          max="100"
          [(ngModel)]="cuponEnEdicion.porcentaje"
          required
          class="input"
          placeholder="10"
        />
      </div>

      <div>
        <label for="minSubtotal">Mínimo subtotal (opcional)</label>
        <input
          id="minSubtotal"
          name="minSubtotal"
          type="number"
          min="0"
          [(ngModel)]="cuponEnEdicion.minSubtotal"
          class="input"
          placeholder="0"
        />
      </div>

      <div class="switch-row">
        <input
          type="checkbox"
          id="cuponActivo"
          name="cuponActivo"
          [(ngModel)]="cuponEnEdicion.activo"
        />
        <label for="cuponActivo">Cupón activo</label>
      </div>
    </div>

    <button
      type="submit"
      class="btn-guardar"
      [disabled]="cuponForm.invalid || guardandoCupon"
    >
      {{ guardandoCupon ? 'Guardando cupón...' : (editandoCupon ? 'Actualizar cupón' : 'Crear cupón') }}
    </button>
  </form>

  <ng-container *ngIf="cupones.length; else sinCupones">
    <table class="tabla-productos cupones-tabla">
      <thead>
        <tr>
          <th>Código</th>
          <th>Descuento</th>
          <th>Mínimo subtotal</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of cupones">
          <td>{{ c.codigo }}</td>
          <td>{{ c.porcentaje }}%</td>
          <td>{{ c.minSubtotal || 0 | currency:'COP':'symbol':'1.0-0' }}</td>
          <td>
            <span class="pill" [class.off]="!c.activo">
              {{ c.activo ? 'Activo' : 'Inactivo' }}
            </span>
          </td>
          <td>
            <button type="button" class="btn-editar" (click)="editarCupon(c)">Editar</button>
            <button type="button" class="btn-eliminar" (click)="eliminarCupon(c)">Eliminar</button>
          </td>
        </tr>
      </tbody>
    </table>
  </ng-container>

  <ng-template #sinCupones>
    <p class="filtro-resultado">No hay cupones registrados.</p>
  </ng-template>
</div>

<div
  class="toast-notification"
  *ngIf="toastActivo"
  [ngClass]="toastActivo.tipo"
  role="status"
  aria-live="assertive"
>
  {{ toastActivo.texto }}
</div>
