<main class="carrito-container">
  <div class="carrito-header">
    <h2>Tu carrito</h2>
    <button class="btn-link" (click)="clear()" *ngIf="(cartItems$ | async)?.length">Vaciar carrito</button>
  </div>

  <ng-container *ngIf="cartItems$ | async as items; else carritoVacio">
    <div class="carrito-content">
      <section class="productos">
        <div class="item" *ngFor="let item of items">
          <img [src]="item.imagen" [alt]="item.nombre" loading="lazy">
          <div class="detalle">
            <h3>{{ item.nombre }}</h3>
            <p *ngIf="item.color">Color: {{ item.color }}</p>
            <p *ngIf="item.sku" class="sku">SKU: {{ item.sku }}</p>
            <div class="acciones">
             <div class="qty">
                <button (click)="decrease(item)" aria-label="Disminuir cantidad">-</button>
                <span>{{ item.qty }}</span>
                <button (click)="increase(item)" aria-label="Aumentar cantidad">+</button>
              </div>
              <strong>{{ (item.precio * item.qty) | currency:'COP':'symbol-narrow':'1.0-0' }}</strong>
            </div>
          </div>
          <button class="remove" (click)="remove(item)" aria-label="Eliminar del carrito">Eliminar</button>
        </div>
      </section>

      <aside class="resumen">
        <h3>Resumen</h3>
        <div class="linea"></div>
        <ng-container *ngIf="totalAmount$ | async as subtotal">
          <div class="shipping-psych">
            <p class="label">Envío fijo a todo Colombia por solo $12.000</p>
            <p class="sub">Entrega rápida y segura</p>
          </div>
          <div class="subtotal">
            <span>Productos ({{ totalItems$ | async }})</span>
            <strong>{{ subtotal | currency:'COP':'symbol-narrow':'1.0-0' }}</strong>
          </div>

          <div class="cupon">
            <input
              type="text"
              placeholder="Cupon (ej: KALAD10)"
              [(ngModel)]="couponCode"
              (keydown.enter)="applyCoupon(subtotal)"
            />
            <button type="button" (click)="applyCoupon(subtotal)">Aplicar</button>
            <button type="button" class="link" *ngIf="discount" (click)="resetDiscount()">Quitar</button>
          </div>

          <p class="cupon-msg" *ngIf="couponMessage">{{ couponMessage }}</p>

          <div class="totales">
            <p>Descuento: <strong>- {{ discount | currency:'COP':'symbol-narrow':'1.0-0' }}</strong></p>
            <p>
              Envio:
              <strong>{{ shipping | currency:'COP':'symbol-narrow':'1.0-0' }}</strong>
            </p>
            <div class="total-final">
              <span>Total</span>
              <strong>{{ (subtotal + shipping - discount) | currency:'COP':'symbol-narrow':'1.0-0' }}</strong>
            </div>
          </div>
          <button class="btn-comprar" type="button" (click)="goToCheckout()">Comprar ahora</button>
        </ng-container>
      </aside>
    </div>
  </ng-container>

  <ng-template #carritoVacio>
    <div class="empty">
      <p>Tu carrito esta vacio. Explora nuestras colecciones.</p>
      <a routerLink="/products" class="btn-comprar">Ver productos</a>
    </div>
  </ng-template>
  <section class="interesar" *ngIf="recommendedProducts.length">
    <div class="interesar-title">
      <span class="line"></span>
      <h3>Te puede interesar</h3>
      <span class="line"></span>
    </div>
    <div class="interesar-grid">
      <article class="card" *ngFor="let prod of recommendedProducts" [routerLink]="['/products', prod.id]">
        <img [src]="prod.imagen" [alt]="prod.nombre" loading="lazy">
        <h4>{{ prod.nombre }}</h4>
        <p>{{ prod.descripcionCorta }}</p>
        <div class="card-footer">
          <span>{{ prod.precio | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
          <button type="button" (click)="addSuggested(prod, $event)">Agregar</button>
        </div>
      </article>
    </div>
  </section>
</main>
