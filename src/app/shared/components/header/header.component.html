<header class="kalad-header">
  <div class="header-container">
    <img src="/assets/images/logo.svg" alt="Logo KALAD" class="kalad-logo" routerLink="/" style="cursor: pointer;">
    <nav class="kalad-nav">
      <a routerLink="/" routerLinkActive="active">Inicio</a>
      <a routerLink="/collections" routerLinkActive="active">Colecciones</a>
      <a routerLink="/products" routerLinkActive="active">Productos</a>
      <a routerLink="/history" routerLinkActive="active">Historia</a>
      <a routerLink="/contact" routerLinkActive="active">Contacto</a>
    </nav>
    <div class="header-icons">
      <div class="header-search" role="button" aria-label="Buscar productos" (click)="toggleSearch($event)">
        <i class="fa-solid fa-magnifying-glass"></i>
      </div>
      <div class="header-auth" role="button" aria-label="Abrir menú de cuenta" (click)="toggleAuthMenu($event)">
        <i class="fa-regular fa-user"></i>
      </div>
      <div class="header-fav" role="button" aria-label="Ver favoritos" (click)="toggleFavorites($event)">
        <ng-container *ngIf="favoritesCount$ | async as fcount">
          <span class="fav-count" *ngIf="fcount">{{ fcount }}</span>
        </ng-container>
        <i class="fa-regular fa-heart"></i>
      </div>

      <div class="header-cart" role="button" aria-label="Ver carrito" (click)="toggleCart($event)">
        <ng-container *ngIf="cartCount$ | async as count">
          <span class="cart-count" *ngIf="count">{{ count }}</span>
        </ng-container>
        <i class="fa-solid fa-cart-shopping"></i>
      </div>
    </div>
  </div>

  <div class="search-layer" *ngIf="showSearch" (click)="$event.stopPropagation()">
    <div class="search-card">
      <div class="search-input">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input
          type="text"
          placeholder="Buscar piezas, colecciones o colores..."
          [value]="searchTerm"
          (input)="onSearchChange($any($event.target).value)"
          autofocus
        />
        <button class="close" (click)="showSearch = false" aria-label="Cerrar búsqueda">&times;</button>
      </div>

      <div class="search-results" *ngIf="!searchLoading; else loadingSearch">
        <ng-container *ngIf="searchResults.length; else emptyResults">
          <div class="result" *ngFor="let prod of searchResults" (click)="goToSearchResult(prod.id)">
            <img [src]="prod.imagen" [alt]="prod.nombre" loading="lazy" />
            <div class="info">
              <p class="title">{{ prod.nombre }}</p>
              <p class="meta">{{ prod.coleccion }} Â· {{ prod.categoria }}</p>
            </div>
            <span class="price">{{ prod.precio | currency:'COP':'symbol-narrow':'1.0-0' }} COP</span>
          </div>
        </ng-container>
        <ng-template #emptyResults>
          <p class="empty">Sin resultados para "{{ searchTerm }}".</p>
        </ng-template>
      </div>
      <ng-template #loadingSearch>
        <p class="loading"><i class="fa-solid fa-spinner fa-spin"></i> Buscando...</p>
      </ng-template>
    </div>
  </div>

  <div class="cart-dropdown" *ngIf="cartOpen" (click)="$event.stopPropagation()">
    <h4>Carrito</h4>
    <ng-container *ngIf="(cartItems$ | async) as items; else emptyCart">
      <div class="cart-item" *ngFor="let item of items">
        <img [src]="item.imagen" [alt]="item.nombre" loading="lazy">
        <div class="cart-item-info">
          <p class="name">{{ item.nombre }}</p>
          <p class="sku" *ngIf="item.sku">SKU: {{ item.sku }}</p>
          <p class="qty">x{{ item.qty }} Â· {{ item.precio | currency:'COP':'symbol-narrow':'1.0-0' }} COP</p>
        </div>
        <button class="remove" (click)="removeItem(item)">×</button>
      </div>
      <div class="cart-summary">
        <span>Total:</span>
        <strong>{{ (cartTotal$ | async) | currency:'COP':'symbol-narrow':'1.0-0' }} COP</strong>
      </div>
      <div class="cart-actions">
        <button (click)="goToCart()">Ver carrito</button>
        <button class="checkout" (click)="goToCheckout()">Comprar ahora</button>
      </div>
    </ng-container>
    <ng-template #emptyCart>
      <p class="empty">Tu carrito está vacío.</p>
    </ng-template>
  </div>

  <div class="fav-dropdown" *ngIf="favoritesOpen" (click)="$event.stopPropagation()">
    <h4>Favoritos</h4>
    <ng-container *ngIf="(favorites$ | async) as favs; else emptyFavs">
      <div class="fav-item" *ngFor="let prod of favs">
        <img [src]="prod.imagen" [alt]="prod.nombre" loading="lazy">
        <div class="fav-item-info" (click)="goToProduct(prod.id)">
          <p class="name">{{ prod.nombre }}</p>
          <p class="price">{{ prod.precio | currency:'COP':'symbol-narrow':'1.0-0' }} COP</p>
        </div>
        <button class="remove" (click)="removeFavorite(prod.id)">×</button>
      </div>
      <div class="fav-actions">
        <button (click)="favoritesOpen = false">Cerrar</button>
      </div>
    </ng-container>
    <ng-template #emptyFavs>
      <p class="empty">No tienes favoritos aún.</p>
    </ng-template>
  </div>

  <div class="auth-dropdown" *ngIf="authMenuOpen" (click)="$event.stopPropagation()">
    <ng-container *ngIf="isLoggedIn$ | async; else loginTpl">
      <p class="auth-status">Sesión activa</p>
      <button class="auth-btn primary" routerLink="/account" (click)="authMenuOpen=false">Ir a mi cuenta</button>
      <button class="auth-btn" (click)="logout($event)">Cerrar sesión</button>
    </ng-container>
    <ng-template #loginTpl>
      <p class="auth-status">Inicia sesión para comprar y guardar favoritos</p>
      <button class="auth-btn primary" (click)="loginWithGoogle($event)">
        <i class="fa-brands fa-google"></i>
        Entrar con Google
      </button>
    </ng-template>
  </div>
</header>

<button class="floating-cart" *ngIf="!isAdminRoute" (click)="toggleCartDrawer($event)">
  <div class="pill">
    <span class="label">Carrito</span>
    <strong>{{ (cartTotal$ | async) | currency:'COP':'symbol-narrow':'1.0-0' }} COP</strong>
    <span class="bubble" *ngIf="cartCount$ | async as count">{{ count }}</span>
  </div>
</button>

<div class="cart-drawer" *ngIf="!isAdminRoute" [class.open]="cartDrawerOpen" (click)="$event.stopPropagation()">
  <div class="drawer-header">
    <div>
      <p class="eyebrow">Tu selección</p>
      <h4>Carrito rápido</h4>
    </div>
    <button class="close" (click)="cartDrawerOpen=false" aria-label="Cerrar carrito">&times;</button>
  </div>
  <ng-container *ngIf="(cartItems$ | async) as items; else drawerEmpty">
    <div class="drawer-list">
      <div class="drawer-item" *ngFor="let item of items">
        <img [src]="item.imagen" [alt]="item.nombre" loading="lazy">
        <div class="info">
          <p class="title">{{ item.nombre }}</p>
          <p class="meta">x{{ item.qty }} Â· {{ item.precio | currency:'COP':'symbol-narrow':'1.0-0' }} COP</p>
        </div>
        <button class="remove" (click)="removeItem(item)">×</button>
      </div>
    </div>
      <div class="drawer-footer">
        <div class="totals">
          <span>Total estimado</span>
          <strong>{{ calcTotal(items) | currency:'COP':'symbol-narrow':'1.0-0' }} COP</strong>
        </div>
        <div class="actions">
          <button class="ghost" (click)="goToCart()">Ver carrito</button>
          <button class="primary" (click)="goToCheckout()">Comprar ahora</button>
        </div>
    </div>
  </ng-container>
  <ng-template #drawerEmpty>
    <p class="drawer-empty">Tu carrito está vacío.</p>
  </ng-template>
</div>

<div class="drawer-backdrop" *ngIf="!isAdminRoute && cartDrawerOpen" (click)="cartDrawerOpen=false"></div>
